{% extends "base.html" %}
{% block content %}

<div class="bg-white p-6 rounded-lg shadow-md mb-8">
    <h2 class="text-2xl font-bold mb-4 text-gray-800">Upload Files</h2>

    <form method="POST" enctype="multipart/form-data" class="flex flex-col gap-4">
        <div class="flex flex-col sm:flex-row gap-4 items-center">
            <input type="file" name="files" id="fileInput" multiple
                class="border border-gray-300 p-2 rounded w-full sm:flex-grow focus:outline-none focus:ring-2 focus:ring-blue-500"
                required>
            <button type="submit"
                class="w-full sm:w-auto bg-blue-600 text-white px-6 py-2 rounded font-bold hover:bg-blue-700 transition duration-200">
                Upload to Cloud
            </button>
        </div>

        <div id="filePreview" class="hidden mt-4 p-4 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
            <div class="mb-2">
                <p class="font-semibold text-gray-800"><span id="fileCount"></span> file(s) selected</p>
                <p class="text-sm text-gray-600" id="totalSize"></p>
            </div>
            <div id="previewContainer" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 mt-4"></div>
        </div>
    </form>
    <p class="text-sm text-gray-500 mt-2">Supported formats: Images (JPG, PNG), Videos (MP4), Documents (PDF, DOCX, TXT).</p>
</div>

<script>
    const fileInput = document.getElementById('fileInput');
    const filePreview = document.getElementById('filePreview');
    const previewContainer = document.getElementById('previewContainer');
    const fileCount = document.getElementById('fileCount');
    const totalSize = document.getElementById('totalSize');

    fileInput.addEventListener('change', function(e) {
        const files = e.target.files;
        if (!files || files.length === 0) {
            filePreview.classList.add('hidden');
            return;
        }
        filePreview.classList.remove('hidden');
        fileCount.textContent = files.length;
        let totalBytes = 0;
        for (let i = 0; i < files.length; i++) {
            totalBytes += files[i].size;
        }
        totalSize.textContent = `Total size: ${formatFileSize(totalBytes)}`;
        previewContainer.innerHTML = '';
        Array.from(files).forEach(file => {
            const fileCard = document.createElement('div');
            fileCard.className = 'bg-white p-2 rounded border border-gray-300 flex flex-col items-center';
            if (file.type.startsWith('image/')) {
                const img = document.createElement('img');
                img.className = 'w-20 h-20 object-cover rounded mb-2';
                img.src = URL.createObjectURL(file);
                img.onload = function() { URL.revokeObjectURL(this.src); };
                fileCard.appendChild(img);
            } else if (file.type.startsWith('video/')) {
                const video = document.createElement('video');
                video.className = 'w-20 h-20 object-cover rounded mb-2';
                video.src = URL.createObjectURL(file);
                video.onload = function() { URL.revokeObjectURL(this.src); };
                fileCard.appendChild(video);
            } else {
                const icon = document.createElement('div');
                icon.className = 'w-20 h-20 flex items-center justify-center bg-gray-100 rounded mb-2';
                icon.innerHTML = '<span class="text-3xl">ðŸ“„</span>';
                fileCard.appendChild(icon);
            }
            const fileName = document.createElement('p');
            fileName.className = 'text-xs text-gray-700 text-center truncate w-full px-1';
            fileName.textContent = file.name;
            fileName.title = file.name;
            fileCard.appendChild(fileName);
            const fileSize = document.createElement('p');
            fileSize.className = 'text-xs text-gray-500 text-center';
            fileSize.textContent = formatFileSize(file.size);
            fileCard.appendChild(fileSize);
            previewContainer.appendChild(fileCard);
        });
    });
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }
</script>

<div class="mb-4 text-gray-700 font-semibold text-lg">Your Files</div>

<div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
    {% for file in files %}
    <div class="bg-white p-4 rounded-lg shadow hover:shadow-xl transition duration-300 flex flex-col justify-between">

        <div class="h-40 bg-gray-50 mb-3 flex items-center justify-center overflow-hidden rounded relative border border-gray-200 group">

            {# Extract extension #}
            {% set ext = file.filename.split('.')[-1].lower() %}

            {# --- UPDATED LOGIC ORDER --- #}

            {# 1. Check for Documents FIRST #}
            {% if ext == 'pdf' %}
                 <div class="flex flex-col items-center justify-center transition duration-300 group-hover:scale-110">
                    <svg class="w-16 h-16 text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"></path></svg>
                    <span class="text-xs font-bold text-red-500 mt-2 uppercase">PDF</span>
                 </div>

            {% elif ext in ['doc', 'docx'] %}
                <div class="flex flex-col items-center justify-center transition duration-300 group-hover:scale-110">
                    <svg class="w-16 h-16 text-blue-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"></path><path d="M7 8h6v2H7V8zm0 4h6v2H7v-2z" fill="white"></path></svg>
                    <span class="text-xs font-bold text-blue-600 mt-2 uppercase">Word</span>
                </div>

            {% elif ext in ['txt'] %}
                <div class="flex flex-col items-center justify-center transition duration-300 group-hover:scale-110">
                    <svg class="w-16 h-16 text-gray-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"></path></svg>
                    <span class="text-xs font-bold text-gray-500 mt-2 uppercase">TXT</span>
                </div>

            {# 2. Check for Images #}
            {% elif file.file_type == 'image' %}
                <img src="{{ file.url }}" class="object-cover w-full h-full hover:scale-105 transition duration-500">

            {# 3. Check for Videos #}
            {% elif file.file_type == 'video' %}
                <video src="{{ file.url }}" class="w-full h-full object-cover" controls preload="metadata"></video>

            {# 4. Fallback for others #}
            {% else %}
                <div class="text-center">
                    <span class="text-5xl">ðŸ“„</span>
                    <p class="text-xs mt-2 text-gray-500 font-mono uppercase">{{ ext }}</p>
                </div>
            {% endif %}
        </div>

        <div class="flex justify-between items-center mt-2">
            <div class="truncate w-2/3 pr-2">
                <p class="font-bold text-gray-800 text-sm truncate" title="{{ file.filename }}">
                    {{ file.filename }}
                </p>
                <a href="{{ file.url }}" target="_blank"
                    class="text-blue-500 text-xs hover:underline flex items-center gap-1 mt-1">
                    Download
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                    </svg>
                </a>
            </div>

            <form action="{{ url_for('delete_file', file_id=file.id) }}" method="POST"
                onsubmit="return confirm('Are you sure you want to permanently delete this file?');">
                <button type="submit"
                    class="bg-red-50 text-red-600 p-2 rounded-full hover:bg-red-600 hover:text-white transition duration-200"
                    title="Delete File">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                </button>
            </form>
        </div>
    </div>
    {% else %}
    <div class="col-span-full text-center py-12 text-gray-500">
        <p class="text-xl">No files uploaded yet.</p>
        <p class="text-sm">Use the form above to add your first file.</p>
    </div>
    {% endfor %}
</div>

{% endblock %}